(function(y,I){typeof exports=="object"&&typeof module<"u"?I(exports,require("xmlbuilder2")):typeof define=="function"&&define.amd?define(["exports","xmlbuilder2"],I):(y=typeof globalThis<"u"?globalThis:y||self,I(y.lightningflowscanner={},y.xmlbuilder2))})(this,function(y,I){"use strict";var W=typeof document<"u"?document.currentScript:null;class w{constructor(t,e,n){this.element={},this.processed=!1,this.type=t,this.element=e,this.childName=n.childName?n.childName:void 0,this.childOf=n.childOf?n.childOf:void 0,e&&"targetReference"in e&&(this.reference=e.targetReference),e&&"connector"in e&&(this.connectorTargetReference=e.connector)}}class U{constructor(t,e,n){this.element={},this.element=n,this.subtype=e,this.metaType=t}}class T extends U{constructor(t,e,n){super("node",e,n),this.connectors=[];const o=e==="start"?"flowstart":t;this.name=o;const s=this.getConnectors(e,n);this.connectors=s,this.locationX=n.locationX,this.locationY=n.locationY}getConnectors(t,e){const n=[];if(t==="start"){if(e.connector&&n.push(new w("connector",e.connector,{})),Array.isArray(e.scheduledPaths))for(const o of(e==null?void 0:e.scheduledPaths)||[])o.connector&&n.push(new w("connector",o.connector,{childName:(o==null?void 0:o.name)??"AsyncAfterCommit",childOf:"scheduledPaths"}));else e.scheduledPaths&&n.push(new w("connector",e.scheduledPaths,{childName:e.scheduledPaths.name,childOf:"scheduledPaths"}));return n}else if(t==="decisions"){if(e.defaultConnector&&n.push(new w("defaultConnector",e.defaultConnector,{})),e.rules)if(Array.isArray(e.rules))for(const o of e.rules)o.connector&&n.push(new w("connector",o.connector,{childName:o.name,childOf:"rules"}));else e.rules.connector&&n.push(new w("connector",e.rules.connector,{childName:e.rules.name,childOf:"rules"}));return n}else{if(t==="assignments")return e.connector?[new w("connector",e.connector,{})]:[];if(t==="loops")return e.nextValueConnector&&n.push(new w("nextValueConnector",e.nextValueConnector,{})),e.noMoreValuesConnector&&n.push(new w("noMoreValuesConnector",e.noMoreValuesConnector,{})),n;if(t==="actionCalls")return e.connector&&n.push(new w("connector",e.connector,{})),e.faultConnector&&n.push(new w("faultConnector",e.faultConnector,{})),n;if(t==="waits"){if(e.defaultConnector&&n.push(new w("defaultConnector",e.defaultConnector,{})),e.faultConnector&&n.push(new w("faultConnector",e.faultConnector,{})),Array.isArray(e.waitEvents))for(const o of e.waitEvents)o.connector&&n.push(new w("connector",o.connector,{childName:o.name,childOf:"waitEvents"}));return n}else return t==="recordCreates"?(e.connector&&n.push(new w("connector",e.connector,{})),e.faultConnector&&n.push(new w("faultConnector",e.faultConnector,{})),n):t==="recordDeletes"?(e.connector&&n.push(new w("connector",e.connector,{})),e.faultConnector&&n.push(new w("faultConnector",e.faultConnector,{})),n):t==="recordLookups"?(e.connector&&n.push(new w("connector",e.connector,{})),e.faultConnector&&n.push(new w("faultConnector",e.faultConnector,{})),n):t==="recordUpdates"?(e.connector&&n.push(new w("connector",e.connector,{})),e.faultConnector&&n.push(new w("faultConnector",e.faultConnector,{})),n):t==="subflows"?e.connector?[new w("connector",e.connector,{})]:[]:t==="screens"?e.connector?[new w("connector",e.connector,{})]:[]:e.connector?[new w("connector",e.connector,{})]:[]}}}class J extends U{constructor(t,e){super("metadata",t,e)}}class D extends U{constructor(t,e,n){super("variable",e,n),this.name=t,this.dataType=n.dataType}}function ce(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}function ue(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}var G={exports:{}},b=G.exports={},A,F;function $(){throw new Error("setTimeout has not been defined")}function H(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?A=setTimeout:A=$}catch{A=$}try{typeof clearTimeout=="function"?F=clearTimeout:F=H}catch{F=H}})();function K(l){if(A===setTimeout)return setTimeout(l,0);if((A===$||!A)&&setTimeout)return A=setTimeout,setTimeout(l,0);try{return A(l,0)}catch{try{return A.call(null,l,0)}catch{return A.call(this,l,0)}}}function fe(l){if(F===clearTimeout)return clearTimeout(l);if((F===H||!F)&&clearTimeout)return F=clearTimeout,clearTimeout(l);try{return F(l)}catch{try{return F.call(null,l)}catch{return F.call(this,l)}}}var S=[],N=!1,M,_=-1;function de(){!N||!M||(N=!1,M.length?S=M.concat(S):_=-1,S.length&&ee())}function ee(){if(!N){var l=K(de);N=!0;for(var t=S.length;t;){for(M=S,S=[];++_<t;)M&&M[_].run();_=-1,t=S.length}M=null,N=!1,fe(l)}}b.nextTick=function(l){var t=new Array(arguments.length-1);if(arguments.length>1)for(var e=1;e<arguments.length;e++)t[e-1]=arguments[e];S.push(new te(l,t)),S.length===1&&!N&&K(ee)};function te(l,t){this.fun=l,this.array=t}te.prototype.run=function(){this.fun.apply(null,this.array)},b.title="browser",b.browser=!0,b.env={},b.argv=[],b.version="",b.versions={};function V(){}b.on=V,b.addListener=V,b.once=V,b.off=V,b.removeListener=V,b.removeAllListeners=V,b.emit=V,b.prependListener=V,b.prependOnceListener=V,b.listeners=function(l){return[]},b.binding=function(l){throw new Error("process.binding is not supported")},b.cwd=function(){return"/"},b.chdir=function(l){throw new Error("process.chdir is not supported")},b.umask=function(){return 0};var he=G.exports;const ne=ue(he);var Q,se;function pe(){if(se)return Q;se=1;function l(o){if(typeof o!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(o))}function t(o,s){for(var r="",i=0,a=-1,u=0,c,f=0;f<=o.length;++f){if(f<o.length)c=o.charCodeAt(f);else{if(c===47)break;c=47}if(c===47){if(!(a===f-1||u===1))if(a!==f-1&&u===2){if(r.length<2||i!==2||r.charCodeAt(r.length-1)!==46||r.charCodeAt(r.length-2)!==46){if(r.length>2){var d=r.lastIndexOf("/");if(d!==r.length-1){d===-1?(r="",i=0):(r=r.slice(0,d),i=r.length-1-r.lastIndexOf("/")),a=f,u=0;continue}}else if(r.length===2||r.length===1){r="",i=0,a=f,u=0;continue}}s&&(r.length>0?r+="/..":r="..",i=2)}else r.length>0?r+="/"+o.slice(a+1,f):r=o.slice(a+1,f),i=f-a-1;a=f,u=0}else c===46&&u!==-1?++u:u=-1}return r}function e(o,s){var r=s.dir||s.root,i=s.base||(s.name||"")+(s.ext||"");return r?r===s.root?r+i:r+o+i:i}var n={resolve:function(){for(var s="",r=!1,i,a=arguments.length-1;a>=-1&&!r;a--){var u;a>=0?u=arguments[a]:(i===void 0&&(i=ne.cwd()),u=i),l(u),u.length!==0&&(s=u+"/"+s,r=u.charCodeAt(0)===47)}return s=t(s,!r),r?s.length>0?"/"+s:"/":s.length>0?s:"."},normalize:function(s){if(l(s),s.length===0)return".";var r=s.charCodeAt(0)===47,i=s.charCodeAt(s.length-1)===47;return s=t(s,!r),s.length===0&&!r&&(s="."),s.length>0&&i&&(s+="/"),r?"/"+s:s},isAbsolute:function(s){return l(s),s.length>0&&s.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var s,r=0;r<arguments.length;++r){var i=arguments[r];l(i),i.length>0&&(s===void 0?s=i:s+="/"+i)}return s===void 0?".":n.normalize(s)},relative:function(s,r){if(l(s),l(r),s===r||(s=n.resolve(s),r=n.resolve(r),s===r))return"";for(var i=1;i<s.length&&s.charCodeAt(i)===47;++i);for(var a=s.length,u=a-i,c=1;c<r.length&&r.charCodeAt(c)===47;++c);for(var f=r.length,d=f-c,C=u<d?u:d,h=-1,p=0;p<=C;++p){if(p===C){if(d>C){if(r.charCodeAt(c+p)===47)return r.slice(c+p+1);if(p===0)return r.slice(c+p)}else u>C&&(s.charCodeAt(i+p)===47?h=p:p===0&&(h=0));break}var k=s.charCodeAt(i+p),z=r.charCodeAt(c+p);if(k!==z)break;k===47&&(h=p)}var L="";for(p=i+h+1;p<=a;++p)(p===a||s.charCodeAt(p)===47)&&(L.length===0?L+="..":L+="/..");return L.length>0?L+r.slice(c+h):(c+=h,r.charCodeAt(c)===47&&++c,r.slice(c))},_makeLong:function(s){return s},dirname:function(s){if(l(s),s.length===0)return".";for(var r=s.charCodeAt(0),i=r===47,a=-1,u=!0,c=s.length-1;c>=1;--c)if(r=s.charCodeAt(c),r===47){if(!u){a=c;break}}else u=!1;return a===-1?i?"/":".":i&&a===1?"//":s.slice(0,a)},basename:function(s,r){if(r!==void 0&&typeof r!="string")throw new TypeError('"ext" argument must be a string');l(s);var i=0,a=-1,u=!0,c;if(r!==void 0&&r.length>0&&r.length<=s.length){if(r.length===s.length&&r===s)return"";var f=r.length-1,d=-1;for(c=s.length-1;c>=0;--c){var C=s.charCodeAt(c);if(C===47){if(!u){i=c+1;break}}else d===-1&&(u=!1,d=c+1),f>=0&&(C===r.charCodeAt(f)?--f===-1&&(a=c):(f=-1,a=d))}return i===a?a=d:a===-1&&(a=s.length),s.slice(i,a)}else{for(c=s.length-1;c>=0;--c)if(s.charCodeAt(c)===47){if(!u){i=c+1;break}}else a===-1&&(u=!1,a=c+1);return a===-1?"":s.slice(i,a)}},extname:function(s){l(s);for(var r=-1,i=0,a=-1,u=!0,c=0,f=s.length-1;f>=0;--f){var d=s.charCodeAt(f);if(d===47){if(!u){i=f+1;break}continue}a===-1&&(u=!1,a=f+1),d===46?r===-1?r=f:c!==1&&(c=1):r!==-1&&(c=-1)}return r===-1||a===-1||c===0||c===1&&r===a-1&&r===i+1?"":s.slice(r,a)},format:function(s){if(s===null||typeof s!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof s);return e("/",s)},parse:function(s){l(s);var r={root:"",dir:"",base:"",ext:"",name:""};if(s.length===0)return r;var i=s.charCodeAt(0),a=i===47,u;a?(r.root="/",u=1):u=0;for(var c=-1,f=0,d=-1,C=!0,h=s.length-1,p=0;h>=u;--h){if(i=s.charCodeAt(h),i===47){if(!C){f=h+1;break}continue}d===-1&&(C=!1,d=h+1),i===46?c===-1?c=h:p!==1&&(p=1):c!==-1&&(p=-1)}return c===-1||d===-1||p===0||p===1&&c===d-1&&c===f+1?d!==-1&&(f===0&&a?r.base=r.name=s.slice(1,d):r.base=r.name=s.slice(f,d)):(f===0&&a?(r.name=s.slice(1,c),r.base=s.slice(1,d)):(r.name=s.slice(f,c),r.base=s.slice(f,d)),r.ext=s.slice(c,d)),f>0?r.dir=s.slice(0,f-1):a&&(r.dir="/"),r},sep:"/",delimiter:":",win32:null,posix:null};return n.posix=n,Q=n,Q}var P=pe();class B extends U{constructor(t,e,n){super("resource",e,n),this.name=t}}class X{constructor(t,e){if(this.flowVariables=["choices","constants","dynamicChoiceSets","formulas","variables"],this.flowResources=["textTemplates","stages"],this.flowMetadata=["description","apiVersion","processMetadataValues","processType","interviewLabel","label","status","runInMode","startElementReference","isTemplate","fullName","timeZoneSidKey","isAdditionalPermissionRequiredToRun","migratedFromWorkflowRuleName","triggerOrder","environments","segment"],this.flowNodes=["actionCalls","apexPluginCalls","assignments","collectionProcessors","decisions","loops","orchestratedStages","recordCreates","recordDeletes","recordLookups","recordUpdates","recordRollbacks","screens","start","steps","subflows","waits"],t){this.fsPath=P.resolve(t);let n=P.basename(P.basename(this.fsPath),P.extname(this.fsPath));n.includes(".")&&(n=n.split(".")[0]),this.name=n}e&&(!!e&&typeof e=="object"&&"Flow"in e?this.xmldata=e.Flow:this.xmldata=e,this.preProcessNodes())}preProcessNodes(){this.label=this.xmldata.label,this.interviewLabel=this.xmldata.interviewLabel,this.processType=this.xmldata.processType,this.processMetadataValues=this.xmldata.processMetadataValues,this.startElementReference=this.xmldata.startElementReference,this.start=this.xmldata.start,this.status=this.xmldata.status,this.type=this.xmldata.processType,this.triggerOrder=this.xmldata.triggerOrder;const t=[];for(const e in this.xmldata){const n=this.xmldata[e];if(this.flowMetadata.includes(e))if(Array.isArray(n))for(const o of n)t.push(new J(e,o));else t.push(new J(e,n));else if(this.flowVariables.includes(e))if(Array.isArray(n))for(const o of n)t.push(new D(o.name,e,o));else t.push(new D(n.name,e,n));else if(this.flowNodes.includes(e))if(Array.isArray(n))for(const o of n)t.push(new T(o.name,e,o));else t.push(new T(n.name,e,n));else if(this.flowResources.includes(e))if(Array.isArray(n))for(const o of n)t.push(new B(o.name,e,o));else t.push(new B(n.name,e,n))}this.elements=t,this.startReference=this.findStart()}findStart(){let t="";const e=this.elements.filter(n=>n instanceof T);return this.startElementReference?t=this.startElementReference:e.find(n=>n.subtype==="start")&&(t=e.find(o=>o.subtype==="start").connectors[0].reference),t}toXMLString(){try{return this.generateDoc()}catch(t){return console.warn(`Unable to write xml, caught an error ${t.toString()}`),""}}generateDoc(){return I.create({encoding:"UTF-8"},{Flow:this.xmldata}).root().att("xmlns","http://soap.sforce.com/2006/04/metadata").end({prettyPrint:!0})}}class R{constructor(t,e,n){this.metaType="attribute",this.name=t,this.subtype=e,this.expression=n}}class v{constructor(t){var e;if(this.violation=t,this.name=t.name,this.metaType=t.metaType,this.type=t.subtype,t.metaType==="variable"){const n=t;this.details={dataType:n.dataType}}if(t.metaType==="node"){const n=t;this.details={locationX:n.locationX,locationY:n.locationY,connectsTo:(e=n.connectors)==null?void 0:e.map(o=>o.reference)}}if(t.metaType==="attribute"){const n=t;this.details={expression:n.expression}}}}class m{constructor(t,e,n){this.details=[],this.ruleDefinition=t,this.ruleName=t.name,this.severity=t.severity?t.severity:"error",this.occurs=!1,this.details=e,e.length>0&&(this.occurs=!0),n&&(this.errorMessage=n)}}class re{constructor(t,e){this.flow=t,this.ruleResults=e}}const E=class E{};E.autolaunchedType="AutoLaunchedFlow",E.backEndTypes=[E.autolaunchedType,"CustomEvent","InvocableProcess","Orchestrator","EvaluationFlow","ActionCadenceAutolaunchedFlow"],E.processBuilder=["Workflow"],E.surveyTypes=["Survey"],E.visualTypes=["Flow","IndividualObjectLinkingFlow","LoginFlow","RoutingFlow","Appointments","ActionCadenceStepFlow","ContactRequestFlow","ContactRequestFlow","CustomerLifecycle","FieldServiceMobile","FieldServiceWeb","SurveyEnrich"],E.unsupportedTypes=["CheckoutFlow","FSCLending","FSCLending","LoyaltyManagementFlow"],E.allTypes=function(){return[...this.backEndTypes,...this.visualTypes,...this.surveyTypes]};let g=E;class Y{constructor(t,e,n){this.uri=t,this.flow=e,n&&(this.errorMessage=n)}}class O{constructor(){this.visitedElements=new Set}traverseFlow(t,e,n,o){var r;let s=[e];for(;s.length>0;){const i=[];for(const a of s)if(!this.visitedElements.has(a)){const u=(r=t.elements)==null?void 0:r.find(c=>c.name===a);u&&(n(u),this.visitedElements.add(a),i.push(...this.findNextElements(t,u,o)))}if(i.length===0)break;s=i}}findNextElements(t,e,n){var s,r;const o=[];if(!e.connectors||e.connectors.length===0)return o;for(const i of e.connectors){const a=((s=i==null?void 0:i.connectorTargetReference)==null?void 0:s.targetReference)??i.reference,u=(r=t.elements)==null?void 0:r.find(c=>c instanceof T&&c.name===a);u instanceof T&&u.name!==n&&o.push(u.name)}return o}}function me(l,t,e){return l[e]=t.map(n=>n.element),l}function ge(l){let t={};for(const e of l){const n=e.subtype,o=l.filter(s=>n===s.subtype);t=me(t,o,n)}return t}function we(l){const t=[];for(const e of l)if(e.ruleResults&&e.ruleResults.length>0){const n=e.ruleResults.filter(o=>o.ruleName==="UnusedVariable"&&o.occurs||o.ruleName==="UnconnectedElement"&&o.occurs);if((n==null?void 0:n.length)>0){const o=ye(e.flow,n);e.flow=o,t.push(e)}}return t}function ye(l,t){var u;const e=t.find(c=>c.ruleName==="UnusedVariable"),n=e&&e.details&&e.details.length>0?e.details.map(c=>c.name):[],o=t.find(c=>c.ruleName==="UnconnectedElement"),s=o&&o.details&&o.details.length>0?o.details.map(c=>c.name):[],r=(u=l.elements)==null?void 0:u.filter(c=>{switch(c.metaType){case"variable":{const f=c;if(!n.includes(f.name))return c;break}case"node":{const f=c;if(!s.includes(f.name))return c;break}case"metadata":case"resource":return c}}),i=ge(r);return new X(l.fsPath,i)}class x{constructor(t,e){this.docRefs=[],this.name=t.name,this.supportedTypes=t.supportedTypes,this.label=t.label,this.description=t.description,this.uri="https://github.com/Lightning-Flow-Scanner/lightning-flow-scanner-core/tree/master/src/main/rules/"+t.name+".ts",this.docRefs=t.docRefs,this.isConfigurable=t.isConfigurable,this.autoFixable=t.autoFixable,this.severity=e&&e.severity?e.severity:"error"}}class be extends x{constructor(){super({name:"APIVersion",label:"Outdated API Version",description:"Introducing newer API components may lead to unexpected issues with older versions of Flows, as they might not align with the underlying mechanics. Starting from API version 50.0, the 'Api Version' attribute has been readily available on the Flow Object. To ensure smooth operation and reduce discrepancies between API versions, it is strongly advised to regularly update and maintain them.",supportedTypes:g.allTypes(),docRefs:[],isConfigurable:!0,autoFixable:!1})}execute(t,e){let n=null;t.xmldata.apiVersion&&(n=+t.xmldata.apiVersion);const o=[];return n?(e&&e.expression&&(new Function(`return ${n}${e.expression};`)()||o.push(new v(new R(`${n}`,"apiVersion",e.expression)))),new m(this,o)):(o.push(new v(new R("API Version <49","apiVersion","<49"))),new m(this,o))}}class ve extends x{constructor(){super({name:"AutoLayout",label:"Auto-Layout Mode",description:"With Canvas Mode set to Auto-Layout, Elements are spaced, connected, and aligned automatically, keeping your Flow neatly organized thus saving you time.",supportedTypes:g.allTypes(),docRefs:[],isConfigurable:!0,autoFixable:!1})}execute(t,e){var n;if(t.processMetadataValues){const o=t.xmldata.processMetadataValues.find(r=>r.name==="CanvasMode");return o.value&&typeof o.value=="object"&&o.value.stringValue&&o.value.stringValue==="AUTO_LAYOUT_CANVAS"?new m(this,[]):new m(this,[new v(new R((n=o.value)==null?void 0:n.stringValue,"CanvasMode","!== AUTO_LAYOUT_CANVAS"))])}return new m(this,[])}}class xe extends x{constructor(){super({name:"CopyAPIName",label:"Copy API Name",description:"Maintaining multiple elements with a similar name, like 'Copy_X_Of_Element,' can diminish the overall readability of your Flow. When copying and pasting these elements, it's crucial to remember to update the API name of the newly created copy.",supportedTypes:g.allTypes(),docRefs:[],isConfigurable:!1,autoFixable:!1})}execute(t){const e=t.elements.filter(s=>s instanceof T),n=[];for(const s of e)new RegExp("Copy_[0-9]+_of_[A-Za-z0-9]+").test(s.name)&&n.push(s);const o=[];for(const s of n)o.push(new v(s));return new m(this,o)}}class Ce extends x{constructor(){super({name:"CyclomaticComplexity",label:"Cyclomatic Complexity",description:"The number of loops and decision rules, plus the number of decisions. Use a combination of 1) subflows and 2) breaking flows into multiple concise trigger ordered flows, to reduce the cyclomatic complexity within a single flow, ensuring maintainability and simplicity.",supportedTypes:g.backEndTypes,docRefs:[{label:"Cyclomatic complexity is a software metric used to indicate the complexity of a program. It is a quantitative measure of the number of linearly independent paths through a program's source code.",path:"https://en.wikipedia.org/wiki/Cyclomatic_complexity"}],isConfigurable:!0,autoFixable:!1},{severity:"note"}),this.defaultThreshold=25,this.cyclomaticComplexityUnit=0}execute(t,e){var a,u;const n=(e==null?void 0:e.threshold)||this.defaultThreshold;let o=1;const s=(a=t==null?void 0:t.elements)==null?void 0:a.filter(c=>c.subtype==="decisions"),r=(u=t==null?void 0:t.elements)==null?void 0:u.filter(c=>c.subtype==="loops");for(const c of s||[]){const f=c.element.rules;Array.isArray(f)?o+=f.length+1:o+=1}o+=(r==null?void 0:r.length)??0,this.cyclomaticComplexityUnit=o;const i=[];return o>n&&i.push(new v(new R(`${o}`,"CyclomaticComplexity",`>${n}`))),new m(this,i)}}class Te extends x{constructor(){super({name:"DMLStatementInLoop",label:"DML Statement In A Loop",description:"To prevent exceeding Apex governor limits, it is advisable to consolidate all your database operations, including record creation, updates, or deletions, at the conclusion of the flow.",supportedTypes:g.backEndTypes,docRefs:[{label:"Flow Best Practices",path:"https://help.salesforce.com/s/articleView?id=sf.flow_prep_bestpractices.htm&type=5"}],isConfigurable:!1,autoFixable:!1})}execute(t){const e=["recordDeletes","recordUpdates","recordCreates"],n=t.elements.filter(i=>i.subtype==="loops"),o=[],s=i=>{e.includes(i.subtype)&&o.push(i)};for(const i of n){let a;i.element.noMoreValuesConnector&&i.element.noMoreValuesConnector?a=i.element.noMoreValuesConnector.targetReference:a=i.name,new O().traverseFlow(t,i.name,s,a)}const r=o.map(i=>new v(i));return new m(this,r)}}class Re extends x{constructor(){super({name:"DuplicateDMLOperation",label:"Duplicate DML Operation",description:"When the flow executes database changes or actions between two screens, it's important to prevent users from navigating back between screens. Failure to do so may result in duplicate database operations being performed within the flow.",supportedTypes:g.visualTypes,docRefs:[],isConfigurable:!1,autoFixable:!1})}execute(t){const e=t.elements.filter(c=>c instanceof T),n=[],o=[],s=[],r=this.findStart(t);if(!r||r===-1)throw"Can not find starting element";let i=!1,a=[r];do if(a=a.filter(c=>!n.includes(c)),a.length>0){for(const[c,f]of e.entries())if(a.includes(c)){const d=[];if(f.connectors&&f.connectors.length>0)for(const C of f.connectors)C.reference&&d.push(C.reference);if(i=this.flagDML(f,i),d.length>0){const C=e.filter(h=>d.includes(h.name));for(const h of C){const p=e.findIndex(k=>h.name===k.name);h.subtype==="screens"&&i&&h.element.allowBack&&h.element.allowBack=="true"&&h.element.showFooter=="true"&&s.push(h),n.includes(p)||a.push(p)}}n.push(c)}}else for(const c of e.keys())n.includes(c)||o.push(c);while(n.length+o.length<e.length);const u=[];for(const c of s)u.push(new v(c));return new m(this,u)}flagDML(t,e){return["recordDeletes","recordUpdates","recordCreates"].includes(t.subtype)?!0:e===!0&&t.subtype==="screens"&&t.element.allowBack&&t.element.allowBack=="true"?!1:e}findStart(t){const e=t.elements.filter(o=>o instanceof T);let n;return t.startElementReference?n=e.findIndex(o=>o.name==t.startElementReference):n=e.findIndex(o=>o.subtype==="start"),n}}class Ae extends x{constructor(){super({name:"FlowDescription",label:"Missing Flow Description",description:"Descriptions play a vital role in documentation. We highly recommend including details about where they are used and their intended purpose.",supportedTypes:[...g.backEndTypes,...g.visualTypes],docRefs:[],isConfigurable:!1,autoFixable:!1})}execute(t){return!t.xmldata.description?new m(this,[new v(new R("undefined","description","!==null"))]):new m(this,[])}}class Fe extends x{constructor(){super({name:"FlowName",label:"Flow Naming Convention",description:"The readability of a flow is of utmost importance. Establishing a naming convention for the Flow Name significantly enhances findability, searchability, and maintains overall consistency. It is advisable to include at least a domain and a brief description of the actions carried out in the flow, for instance, 'Service_OrderFulfillment'.",supportedTypes:g.allTypes(),docRefs:[{label:"Naming your Flows is more critical than ever. By Stephen Church",path:"https://www.linkedin.com/posts/stephen-n-church_naming-your-flows-this-is-more-critical-activity-7099733198175158274-1sPx?utm_source=share&utm_medium=member_desktop"}],isConfigurable:!0,autoFixable:!1})}execute(t,e){const n=e&&e.expression?e.expression:"[A-Za-z0-9]+_[A-Za-z0-9]+";return new RegExp(n).test(t.name)?new m(this,[]):new m(this,[new v(new R(t.name,"name",n))])}}class Ee extends x{constructor(){super({name:"HardcodedId",label:"Hardcoded Id",description:"Avoid hard-coding IDs as they are org-specific. Instead, pass them into variables at the start of the flow. You can achieve this by utilizing merge fields in URL parameters or employing a Get Records element.",supportedTypes:g.allTypes(),docRefs:[{label:"Flow Best Practices",path:"https://help.salesforce.com/s/articleView?id=sf.flow_prep_bestpractices.htm&type=5"},{label:"Don't hard code Record Type IDs in Flow. By Stephen Church.",path:"https://www.linkedin.com/feed/update/urn:li:activity:6947530300012826624/?updateEntityUrn=urn%3Ali%3Afs_feedUpdate%3A%28V2%2Curn%3Ali%3Aactivity%3A6947530300012826624%29"}],isConfigurable:!1,autoFixable:!1})}execute(t){const e=[],n=/\b[a-zA-Z0-9]{5}0[a-zA-Z0-9]{9}([a-zA-Z0-9]{3})?\b/g;for(const s of t.elements){const r=JSON.stringify(s);n.test(r)&&e.push(s)}const o=e.map(s=>new v(s));return new m(this,o)}}class Se extends x{constructor(){super({name:"InactiveFlow",label:"Inactive Flow",description:"Like cleaning out your closet: deleting unused flows is essential. Inactive flows can still cause trouble, like accidentally deleting records during testing, or being activated as subflows within parent flows.",supportedTypes:g.allTypes(),docRefs:[],isConfigurable:!1,autoFixable:!1})}execute(t){const e=[];return t.status!=="Active"&&e.push(new v(new R(t.status,"status","!= Active"))),new m(this,e)}}class Ve extends x{constructor(){super({name:"MissingFaultPath",label:"Missing Fault Path",description:"At times, a flow may fail to execute a configured operation as intended. By default, the flow displays an error message to the user and notifies the admin who created the flow via email. However, you can customize this behavior by incorporating a Fault Path.",supportedTypes:[...g.backEndTypes,...g.visualTypes],docRefs:[{label:"Flow Best Practices",path:"https://help.salesforce.com/s/articleView?id=sf.flow_prep_bestpractices.htm&type=5"}],isConfigurable:!1,autoFixable:!1}),this.applicableElements=["recordLookups","recordDeletes","recordUpdates","recordCreates","waits","actionCalls"]}execute(t){var i;const e=new O,n=[],o=((i=t.elements)==null?void 0:i.filter(a=>{const u=a;return this.applicableElements.includes(u.subtype)})).map(a=>a.name),s=t.start.triggerType==="RecordBeforeSave",r=a=>{if(!a.connectors.find(u=>u.type==="faultConnector")&&o.includes(a.name)){if(s&&a.subtype==="recordUpdates")return;this.isPartOfFaultHandlingFlow(a,t)||n.push(new v(a))}};return e.traverseFlow(t,t.startReference,r),new m(this,n)}isPartOfFaultHandlingFlow(t,e){var o;const n=(o=e.elements)==null?void 0:o.filter(s=>s instanceof T);for(const s of n)if(s!==t&&s.connectors.find(r=>r.type==="faultConnector"&&r.reference===t.name))return!0;return!1}}class Le extends x{constructor(){super({name:"MissingNullHandler",label:"Missing Null Handler",description:"When a Get Records operation doesn't find any data, it returns null. To ensure data validation, utilize a decision element on the operation result variable to check for a non-null result.",supportedTypes:[...g.backEndTypes,...g.visualTypes],docRefs:[],isConfigurable:!1,autoFixable:!1})}execute(t){const e=["recordLookups"],n=t.elements.filter(i=>i.metaType==="node"&&e.includes(i.subtype)),o=t.elements.filter(i=>i.metaType==="node"&&i.subtype==="decisions"),s=[];for(const i of n){const a=i.name;let u=!1,c=[];if(i.element.storeOutputAutomatically)c=[a];else if(i.element.outputReference)c=i.element.outputReference;else if(i.element.outputAssignments){const f=i.element.outputAssignments;for(const d of f)c.push(d.assignToReference)}for(const f of o){const d=f.element.rules;for(const C of d)for(const h of C.conditions){let p=!1,k=!1,z=!1;if(h.leftValueReference&&h.leftValueReference.length>0){const L=h.leftValueReference;for(const We of c)if(p=We.includes(L),p)break}h.operator&&h.operator.length>0&&(k=h.operator==="IsNull"),h.rightValue&&h.rightValue.length>0&&h.rightValue.booleanValue&&h.rightValue.booleanValue.length>0&&(z=h.rightValue.booleanValue.toLowerCase()==="false"),p&&k&&z&&(u=!0)}}u||s.push(i)}const r=[];for(const i of s)r.push(new v(i));return new m(this,r)}}class Me extends x{constructor(){super({name:"ProcessBuilder",label:"No Process Builder",description:"Salesforce is transitioning away from Workflow Rules and Process Builder in favor of Flow. Ensure you're prepared for this transition by migrating your organization's automation to Flow. Refer to official documentation for more information on the transition process and tools available.",supportedTypes:g.processBuilder,docRefs:[{label:"Process Builder Retirement",path:"https://help.salesforce.com/s/articleView?id=000389396&type=1"}],isConfigurable:!0,autoFixable:!1})}execute(t,e){return new m(this,[new v(new R("Workflow","processType","== Workflow"))])}}class Pe extends x{constructor(){super({name:"SOQLQueryInLoop",label:"SOQL Query In A Loop",description:"To prevent exceeding Apex governor limits, it is advisable to consolidate all your SOQL queries at the conclusion of the flow.",supportedTypes:g.backEndTypes,docRefs:[{label:"Flow Best Practices",path:"https://help.salesforce.com/s/articleView?id=sf.flow_prep_bestpractices.htm&type=5"}],isConfigurable:!1,autoFixable:!1})}execute(t){const e=["recordLookups"],n=t.elements.filter(i=>i.subtype==="loops"),o=[],s=i=>{e.includes(i.subtype)&&o.push(i)};for(const i of n){let a;i.element.noMoreValuesConnector&&i.element.noMoreValuesConnector?a=i.element.noMoreValuesConnector.targetReference:a=i.name,new O().traverseFlow(t,i.name,s,a)}const r=o.map(i=>new v(i));return new m(this,r)}}class ke extends x{constructor(){super({name:"UnconnectedElement",label:"Unconnected Element",description:"To maintain the efficiency and manageability of your Flow, it's best to avoid including unconnected elements that are not in use.",supportedTypes:[...g.backEndTypes,...g.visualTypes],docRefs:[],isConfigurable:!1,autoFixable:!0})}execute(t){const e=new Set,n=a=>{e.add(a.name)},o=t.elements.filter(a=>a instanceof T),s=this.findStart(o);s!==-1&&new O().traverseFlow(t,o[s].name,n);const i=o.filter(a=>!e.has(a.name)).map(a=>new v(a));return new m(this,i)}findStart(t){return t.findIndex(e=>e.subtype==="start")}}class Ie extends x{constructor(){super({name:"UnsafeRunningContext",label:"Unsafe Running Context",description:"This flow is configured to run in System Mode without Sharing. This system context grants all running users the permission to view and edit all data in your org. Running a flow in System Mode without Sharing can lead to unsafe data access.",supportedTypes:[...g.backEndTypes,...g.visualTypes],docRefs:[{label:"Learn about data safety when running flows in system context in Salesforce Help",path:"https://help.salesforce.com/s/articleView?id=sf.flow_distribute_context_data_safety_system_context.htm&type=5"}],isConfigurable:!1,autoFixable:!1},{severity:"warning"})}execute(t){const e="runInMode"in t.xmldata,n=e?t.xmldata.runInMode:void 0,o="SystemModeWithoutSharing",s=[];return e&&n===o&&s.push(new v(new R(n,"runInMode",`== ${o}`))),new m(this,s)}}class Ne extends x{constructor(){super({name:"UnusedVariable",label:"Unused Variable",description:"To maintain the efficiency and manageability of your Flow, it's advisable to avoid including unconnected variables that are not in use.",supportedTypes:[...g.backEndTypes,...g.visualTypes],docRefs:[],isConfigurable:!1,autoFixable:!0})}execute(t){const e=[];for(const o of t.elements.filter(s=>s instanceof D)){const s=o.name;if([...JSON.stringify(t.elements.filter(r=>r instanceof T)).matchAll(new RegExp(s,"gi"))].map(r=>r.index).length===0&&[...JSON.stringify(t.elements.filter(r=>r instanceof B)).matchAll(new RegExp(s,"gi"))].map(r=>r.index).length===0){const r=[...JSON.stringify(o).matchAll(new RegExp(o.name,"gi"))].map(a=>a.index);[...JSON.stringify(t.elements.filter(a=>a instanceof D)).matchAll(new RegExp(s,"gi"))].map(a=>a.index).length===r.length&&e.push(o)}}const n=[];for(const o of e)n.push(new v(o));return new m(this,n)}}class Ue extends x{constructor(){super({name:"SameRecordFieldUpdates",label:"Same Record Field Updates",description:"Before-save same-record field updates allows you to update the record using variable assignments to `$Record`. This is significantly faster than doing another DML on the same-record that triggered the flow",supportedTypes:[...g.backEndTypes],docRefs:[{label:"Learn about same record field updates",path:"https://architect.salesforce.com/decision-guides/trigger-automation#Same_Record_Field_Updates"}],isConfigurable:!1,autoFixable:!1},{severity:"warning"}),this.qualifiedRecordTriggerTypes=new Set(["Create","Update","CreateAndUpdate"])}execute(t){var r,i,a;const e=[],n=((r=t.start)==null?void 0:r.triggerType)==="RecordBeforeSave",o=this.qualifiedRecordTriggerTypes.has((i=t.start)==null?void 0:i.recordTriggerType);if(!n||!o)return new m(this,e);const s=(a=t.elements)==null?void 0:a.filter(u=>u.subtype==="recordUpdates");if(s==null||typeof s[Symbol.iterator]!="function")return new m(this,e);for(const u of s)typeof u.element=="object"&&"inputReference"in u.element&&u.element.inputReference==="$Record"&&e.push(new v(u));return new m(this,e)}}class De extends x{constructor(){super({name:"TriggerOrder",label:"Trigger Order",description:"With flow trigger ordering, introduced in Spring '22, admins can now assign a priority value to their flows and guarantee their execution order. This priority value is not an absolute value, so the values need not be sequentially numbered as 1, 2, 3, and so on.",supportedTypes:[g.autolaunchedType],docRefs:[{label:"Learn more about flow ordering orchestration",path:"https://architect.salesforce.com/decision-guides/trigger-automation#Ordering___Orchestration"}],isConfigurable:!1,autoFixable:!1},{severity:"note"}),this.qualifiedRecordTriggerTypes=new Set(["Create","Update"])}execute(t){const e=[];return"object"in t.start?(t.triggerOrder||e.push(new v(new R("TriggerOrder","TriggerOrder","10, 20, 30 ..."))),new m(this,e)):new m(this,e)}}const q={APIVersion:be,AutoLayout:ve,CopyAPIName:xe,CyclomaticComplexity:Ce,DMLStatementInLoop:Te,DuplicateDMLOperation:Re,FlowDescription:Ae,FlowName:Fe,HardcodedId:Ee,MissingFaultPath:Ve,MissingNullHandler:Le,ProcessBuilder:Me,SOQLQueryInLoop:Pe,UnconnectedElement:ke,UnusedVariable:Ne,TriggerOrder:De,InactiveFlow:Se,UnsafeRunningContext:Ie,SameRecordFieldUpdates:Ue};class oe{static loadCustomRule(t,e){try{const n=P.resolve(ne.cwd(),e),o=require(n);if(o[t]&&typeof o[t]=="function")return new o[t];console.error(`Error: ${e} does not export ${t} class.`);return}catch(n){console.error(`Error importing ${e}:`,n);return}}}class ie{constructor(t){if(q[t]===void 0||q[t]===null){const e=oe.loadCustomRule(t,P.join(new URL(typeof document>"u"&&typeof location>"u"?require("url").pathToFileURL(__filename).href:typeof document>"u"?location.href:W&&W.tagName.toUpperCase()==="SCRIPT"&&W.src||new URL("lightning-flow-scanner-core.umd.js",document.baseURI).href).pathname,`../../rules/${t}`));if(e)return e;throw new Error(`Rule '${t}' does not exist in the store.`)}return new q[t]}}function j(l){var e,n;const t=[];if(l&&l instanceof Map)for(const o of l.keys()){let s="error";try{const r=(e=l.get(o))==null?void 0:e.path,i=(n=l.get(o))==null?void 0:n.severity;if(i&&(i==="error"||i==="warning"||i==="note")&&(s=i),r){const a=oe.loadCustomRule(o,r);t.severity=s,t.push(a)}else{const a=new ie(o);a.severity=s,t.push(a)}}catch(r){console.log(r.message)}}else for(const o in q){const s=new ie(o);t.push(s)}return t}function Oe(l){if(l&&l.length>0){const t=new Map(l.map(e=>[e,"error"]));return j(t)}else return j()}var Z,ae;function _e(){if(ae)return Z;ae=1;var l=null;return Z=l,Z}var Be=_e();const qe=ce(Be);async function je(l){const t=[];for(const e of l)try{const n=P.normalize(e),s=(await qe.readFileSync(n)).toString(),r=I.convert(s,{format:"object"});t.push(new Y(e,new X(e,r)))}catch(n){t.push(new Y(e,void 0,n.errorMessage))}return t}function ze(l,t){const e=[];for(const o of l)!o.errorMessage&&o.flow&&e.push(o.flow);let n;if(t!=null&&t.rules&&Object.entries(t.rules).length>0?n=le(e,t):n=le(e),t!=null&&t.exceptions){for(const[o,s]of Object.entries(t.exceptions))for(const r of n)if(r.flow.name===o){for(const i of r.ruleResults)if(s[i.ruleName]){const a=s[i.ruleName],u=i.details.filter(c=>!a.includes(c.name));i.details=u,i.occurs=u.length>0}}}return n}function le(l,t){const e=[];let n=[];if(t&&t.rules){const o=new Map;for(const[s,r]of Object.entries(t.rules))o.set(s,r);n=j(o)}else n=j();for(const o of l){const s=[];for(const r of n)try{if(r.supportedTypes.includes(o.type)){let i;t&&t.rules&&t.rules[r.name]&&(i=t.rules[r.name]);const a=i&&Object.keys(i).length>0?r.execute(o,i):r.execute(o);a.severity!==r.severity&&(a.severity=r.severity),s.push(a)}else s.push(new m(r,[]))}catch{const a="Something went wrong while executing "+r.name+" in the Flow: '"+o.name;s.push(new m(r,[],a))}e.push(new re(o,s))}return e}y.Compiler=O,y.Flow=X,y.FlowAttribute=R,y.FlowElement=U,y.FlowNode=T,y.FlowResource=B,y.FlowType=g,y.FlowVariable=D,y.ParsedFlow=Y,y.ResultDetails=v,y.RuleResult=m,y.ScanResult=re,y.fix=we,y.getRules=Oe,y.parse=je,y.scan=ze,Object.defineProperty(y,Symbol.toStringTag,{value:"Module"})});
