<template>
    <div class="page">
        <a class="hidden-csv-link" style="display:none"></a>

        <!-- SINGLE-FLOW MODE -->
        <template if:false={isAllMode}>
            <div class="single-flow-wrapper">
                <!-- Flow Info Header -->
                <template if:true={hasFlowName}>
                    <div class="flow-header">
                        <div class="flow-container">
                            <!-- Column 1 -->
                            <div class="flow-column">
                                <p class="info-item"><strong>Name:</strong> {name}</p>
                                <p class="info-item"><strong>Label:</strong> {metadata.label}</p>
                                <p class="info-item"><strong>Status:</strong> {metadata.status}</p>
                            </div>
                            <!-- Column 2 -->
                            <div class="flow-column">
                                <p class="info-item"><strong>Type:</strong> {metadata.processType}</p>
                                <p class="info-item"><strong>API Version:</strong> {metadata.apiVersion}</p>
                                <p class="info-item"><strong># Rules Run:</strong> {numberOfRules}</p>
                            </div>
                            <!-- Column 3 -->
                            <div class="flow-column">
                                <p class="info-item"><strong>Description:</strong> {metadata.description}</p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Error -->
                <template if:true={error}>
                    <p class="error">Error scanning Flow: {error}</p>
                </template>

                <!-- Table -->
                <template if:true={hasScanResults}>
                    <div class="custom-datatable">
                        <table class="slds-table slds-table_cell-buffer slds-table_bordered full-width-table">
                            <thead>
                                <tr>
                                    <th data-field="ruleName" onclick={handleSort}>Rule Name {sortIndicators.ruleName}</th>
                                    <th data-field="severity" onclick={handleSort}>Severity {sortIndicators.severity}</th>
                                    <th data-field="name" onclick={handleSort}>Violation Name {sortIndicators.name}</th>
                                    <th data-field="type" onclick={handleSort}>Type {sortIndicators.type}</th>
                                    <th data-field="metaType" onclick={handleSort}>Meta Type {sortIndicators.metaType}</th>
                                    <th data-field="dataType" onclick={handleSort}>Data Type {sortIndicators.dataType}</th>
                                    <th data-field="locationX" onclick={handleSort}>Location X {sortIndicators.locationX}</th>
                                    <th data-field="locationY" onclick={handleSort}>Location Y {sortIndicators.locationY}</th>
                                    <th data-field="connectsTo" onclick={handleSort}>Connects To {sortIndicators.connectsTo}</th>
                                    <th data-field="expression" onclick={handleSort}>Expression {sortIndicators.expression}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template for:each={filteredViolations} for:item="v">
                                    <tr key={v.id}>
                                        <td>{v.ruleName}</td>
                                        <td>{v.severity}</td>
                                        <td>{v.name}</td>
                                        <td>{v.type}</td>
                                        <td>{v.metaType}</td>
                                        <td>{v.dataType}</td>
                                        <td>{v.locationX}</td>
                                        <td>{v.locationY}</td>
                                        <td>{v.connectsTo}</td>
                                        <td class="expression-cell">{v.expression}</td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </template>
            </div>
        </template>

        <!-- ALL-FLOWS MODE -->
        <template if:true={isAllMode}>
            <div class="all-mode-container">
                <template if:true={allScanResults}>
                    <!-- Toolbar -->
                    <div class="slds-grid slds-grid_vertical-align-center slds-grid_align-spread toolbar-row">
                        <div class="toolbar-icon">
                            <lightning-icon icon-name="standard:work_order" size="small"></lightning-icon>
                        </div>
                        <div class="toolbar-title slds-p-left_x-small">
                            <h2 class="slds-text-heading_small slds-truncate">All Results</h2>
                        </div>
                        <div class="toolbar-item slds-p-left_x-small">
                            <lightning-input type="search" placeholder="Flow Name" onkeyup={handleFlowNameFilter}
                                variant="label-hidden" class="compact-input"></lightning-input>
                        </div>
                        <div class="toolbar-item slds-p-left_x-small">
                            <lightning-input type="search" placeholder="Search All Fields"
                                onkeyup={handleOtherFieldsFilter} variant="label-hidden"
                                class="compact-input"></lightning-input>
                        </div>
                        <div class="toolbar-item slds-p-left_x-small">
                            <span class="slds-text-body_small toolbar-stats">
                                <strong>Violations: {displayedViolationsCount} / {totalViolationsCount}</strong>
                            </span>
                        </div>
                        <div class="toolbar-item toolbar-button-container">
                            <lightning-button label="Export CSV" icon-name="utility:download" onclick={handleDownload}
                                variant="brand" class="slds-button slds-button_brand"></lightning-button>
                        </div>
                    </div>

                    <!-- Table Card -->
                    <lightning-card>
                        <template if:true={hasFlattenedViolations}>
                            <div class="custom-datatable">
                                <table class="slds-table slds-table_cell-buffer full-width-table">
                                    <thead>
                                        <tr>
                                            <th data-field="flowName" onclick={handleSort}>Flow {sortIndicators.flowName}</th>
                                            <th data-field="ruleName" onclick={handleSort}>Rule Name {sortIndicators.ruleName}</th>
                                            <th data-field="severity" onclick={handleSort}>Severity {sortIndicators.severity}</th>
                                            <th data-field="name" onclick={handleSort}>Violation Name {sortIndicators.name}</th>
                                            <th data-field="type" onclick={handleSort}>Type {sortIndicators.type}</th>
                                            <th data-field="metaType" onclick={handleSort}>Meta Type {sortIndicators.metaType}</th>
                                            <th data-field="dataType" onclick={handleSort}>Data Type {sortIndicators.dataType}</th>
                                            <th data-field="locationX" onclick={handleSort}>Location X {sortIndicators.locationX}</th>
                                            <th data-field="locationY" onclick={handleSort}>Location Y {sortIndicators.locationY}</th>
                                            <th data-field="connectsTo" onclick={handleSort}>Connects To {sortIndicators.connectsTo}</th>
                                            <th data-field="expression" onclick={handleSort}>Expression {sortIndicators.expression}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template for:each={filteredViolations} for:item="v">
                                            <tr key={v.id}>
                                                <td>{v.flowName}</td>
                                                <td>{v.ruleName}</td>
                                                <td>{v.severity}</td>
                                                <td>{v.name}</td>
                                                <td>{v.type}</td>
                                                <td>{v.metaType}</td>
                                                <td>{v.dataType}</td>
                                                <td>{v.locationX}</td>
                                                <td>{v.locationY}</td>
                                                <td>{v.connectsTo}</td>
                                                <td class="expression-cell">{v.expression}</td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </template>

                        <!-- No violations -->
                        <template if:false={hasFlattenedViolations}>
                            <template if:true={totalViolationsCount}>
                                <p class="slds-p-horizontal_small">
                                    No violations match your search criteria. Try adjusting your filters.
                                </p>
                            </template>
                            <template if:false={totalViolationsCount}>
                                <p class="slds-p-horizontal_small slds-text-color_success">
                                    No violations found across all scanned flows. Great job! 🎉
                                </p>
                            </template>
                        </template>
                    </lightning-card>
                </template>
            </div>
        </template>

        <!-- Footer -->
        <div class="footer">
            <div class="github-info">
                Want to help improve&nbsp;
                <a href="https://flow-scanner.github.io/lightning-flow-scanner-core/" target="_blank">Lightning Flow
                    Scanner</a>
                ?&nbsp;See our&nbsp;
                <a href="https://github.com/Flow-Scanner/lightning-flow-scanner-core?tab=contributing-ov-file"
                    target="_blank">Contributing Guidelines</a>.
            </div>

            <template if:false={isAllMode}>
                <div class="navigation-buttons">
                    <lightning-button label="Previous Flow" variant="brand" disabled={isFirstFlow}
                        onclick={handlePreviousFlow}></lightning-button>
                    <lightning-button label="Next Flow" variant="brand" disabled={isLastFlow}
                        onclick={handleNextFlow}></lightning-button>
                </div>
            </template>
        </div>
    </div>
</template>
