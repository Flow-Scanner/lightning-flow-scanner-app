<template>
    <div class="page">
        <a class="hidden-csv-link" style="display:none"></a>
        <!-- SINGLE-FLOW MODE -->
        <template if:false={isAllMode}>
            <div class="single-flow-wrapper">
                <!-- Flow Info Header -->
                <template if:true={hasFlowName}>
                    <div class="flow-header">
                        <div class="flow-container">
                            <!-- Column 1 -->
                            <div class="flow-column">
                                <p class="info-item"><strong>Name:</strong> {name}</p>
                                <p class="info-item"><strong>Label:</strong> {metadata.label}</p>
                                <p class="info-item"><strong>Status:</strong> {metadata.status}</p>
                            </div>

                            <!-- Column 2 -->
                            <div class="flow-column">
                                <p class="info-item"><strong>Type:</strong> {metadata.processType}</p>
                                <p class="info-item"><strong>API Version:</strong> {metadata.apiVersion}</p>
                                <p class="info-item"><strong># Rules Run:</strong> {numberOfRules}</p>
                            </div>

                            <!-- Column 3 -->
                            <div class="flow-column">
                                <p class="info-item"><strong>Description:</strong> {metadata.description}</p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Error -->
                <template if:true={error}>
                    <p class="error">Error scanning Flow: {error}</p>
                </template>

                <!-- Table -->
                <template if:true={hasScanResults}>
                    <div class="custom-datatable">
                        <table class="slds-table slds-table_cell-buffer slds-table_bordered full-width-table">
                            <thead>
                                <tr>
                                    <th>Rule Name</th>
                                    <th>Severity</th>
                                    <th>Violation Name</th>
                                    <th>Type</th>
                                    <th>Meta Type</th>
                                    <th>Data Type</th>
                                    <th>Location X</th>
                                    <th>Location Y</th>
                                    <th>Connects To</th>
                                    <th>Expression</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template for:each={scanResult.ruleResults} for:item="rule">
                                    <template for:each={rule.details} for:item="detail">
                                        <tr key={detail.id}>
                                            <td>{rule.ruleName}</td>
                                            <td>{rule.severity}</td>
                                            <td>{detail.name}</td>
                                            <td>{detail.type}</td>
                                            <td>{detail.metaType}</td>
                                            <td>{detail.details.dataType}</td>
                                            <td>{detail.details.locationX}</td>
                                            <td>{detail.details.locationY}</td>
                                            <td>{detail.connectsTo}</td>
                                            <td class="expression-cell">{detail.details.expression}</td>
                                        </tr>
                                    </template>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </template>
            </div>
        </template>

        <!-- ALL-FLOWS MODE -->
        <template if:true={isAllMode}>
            <div class="all-mode-container">
                <template if:true={allScanResults}>
                    <div slot="title"
                        class="slds-grid slds-grid_vertical-align-center slds-p-around_xx-small toolbar-row">
                        <div class="toolbar-icon">
                            <lightning-icon icon-name="standard:work_order" size="small"></lightning-icon>
                        </div>
                        <div class="toolbar-title slds-p-left_x-small">
                            <h2 class="slds-text-heading_small slds-truncate">All Results</h2>
                        </div>
                        <div class="toolbar-item slds-p-left_x-small">
                            <lightning-input type="search" placeholder="Flow Name" onkeyup={handleFlowNameFilter}
                                variant="label-hidden" class="compact-input"></lightning-input>
                        </div>
                        <div class="toolbar-item slds-p-left_x-small">
                            <lightning-input type="search" placeholder="Search All Fields"
                                onkeyup={handleOtherFieldsFilter} variant="label-hidden"
                                class="compact-input"></lightning-input>
                        </div>
                        <div class="toolbar-item slds-p-left_x-small slds-align-middle">
                            <span class="slds-text-body_small toolbar-stats">
                                <strong>Violations:</strong> {displayedViolationsCount} / {totalViolationsCount}
                            </span>
                        </div>
                        <div class="toolbar-item slds-p-left_x-small">
                            <lightning-button label="Export CSV" icon-name="utility:download" onclick={handleDownload}
                                variant="brand" class="toolbar-button slds-m-left_small"></lightning-button>
                        </div>

                    </div>
                    <lightning-card>

                        <template if:true={hasFlattenedViolations}>
                            <div class="custom-datatable">
                                <table class="slds-table slds-table_cell-buffer full-width-table">
                                    <thead>
                                        <tr>
                                            <th>Flow</th>
                                            <th>Rule Name</th>
                                            <th>Severity</th>
                                            <th>Violation Name</th>
                                            <th>Type</th>
                                            <th>Meta Type</th>
                                            <th>Data Type</th>
                                            <th>Location X</th>
                                            <th>Location Y</th>
                                            <th>Connects To</th>
                                            <th>Expression</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template for:each={filteredViolations} for:item="violation">
                                            <tr key={violation.id}>
                                                <td>{violation.flowName}</td>
                                                <td>{violation.ruleName}</td>
                                                <td>{violation.severity}</td>
                                                <td>{violation.name}</td>
                                                <td>{violation.type}</td>
                                                <td>{violation.metaType}</td>
                                                <td>{violation.dataType}</td>
                                                <td>{violation.locationX}</td>
                                                <td>{violation.locationY}</td>
                                                <td>{violation.connectsTo}</td>
                                                <td class="expression-cell">{violation.expression}</td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </template>
                        <template if:false={hasFlattenedViolations}>
                            <template if:true={totalViolationsCount}>
                                <p class="slds-p-horizontal_small">
                                    No violations match your search criteria. Try adjusting your filters.
                                </p>
                            </template>
                            <template if:false={totalViolationsCount}>
                                <p class="slds-p-horizontal_small slds-text-color_success">
                                    No violations found across all scanned flows. Great job! ðŸŽ‰
                                </p>
                            </template>
                        </template>
                    </lightning-card>
                </template>




            </div>

        </template>

        <!-- Footer -->
        <div class="footer">
            <div class="github-info">
                Want to help improve&nbsp;
                <a href="https://flow-scanner.github.io/lightning-flow-scanner-core/" target="_blank">Lightning Flow
                    Scanner</a>
                ?&nbsp;See our&nbsp;
                <a href="https://github.com/Flow-Scanner/lightning-flow-scanner-core/blob/main/CONTRIBUTING.md"
                    target="_blank">Contributing Guidelines</a>.
            </div>
            <template if:false={isAllMode}>
                <div class="navigation-buttons">
                    <lightning-button label="Previous Flow" variant="brand" disabled={isFirstFlow}
                        onclick={handlePreviousFlow}></lightning-button>
                    <lightning-button label="Next Flow" variant="brand" disabled={isLastFlow}
                        onclick={handleNextFlow}></lightning-button>
                </div>
            </template>
        </div>

    </div>
</template>